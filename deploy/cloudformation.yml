AWSTemplateFormatVersion: "2010-09-09"
Description: Ethos Academy — EC2 with Docker Compose

Parameters:
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: SSH key pair for EC2 access

  InstanceType:
    Type: String
    Default: t3.medium
    AllowedValues: [t3.small, t3.medium, t3.large]

  MyIP:
    Type: String
    Description: Your IP for SSH access (e.g. 203.0.113.0/32)
    AllowedPattern: "\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}/\\d{1,2}"

Resources:
  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Ethos Academy server
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref MyIP
          Description: SSH from my IP
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS
      Tags:
        - Key: Name
          Value: ethos-academy-sg

  ElasticIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: ethos-academy-eip

  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      KeyName: !Ref KeyPairName
      ImageId: !FindInMap [RegionAMI, !Ref "AWS::Region", AMI]
      SecurityGroupIds:
        - !GetAtt SecurityGroup.GroupId
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 30
            VolumeType: gp3
      Tags:
        - Key: Name
          Value: ethos-academy
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -euo pipefail
          exec > /var/log/user-data.log 2>&1

          # Install Docker
          apt-get update
          apt-get install -y ca-certificates curl git
          install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
          chmod a+r /etc/apt/keyrings/docker.asc
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo $VERSION_CODENAME) stable" > /etc/apt/sources.list.d/docker.list
          apt-get update
          apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
          usermod -aG docker ubuntu

          # Clone repo
          sudo -u ubuntu git clone https://github.com/allierays/ethos.git /home/ubuntu/ethos

  EIPAssociation:
    Type: AWS::EC2::EIPAssociation
    Properties:
      AllocationId: !GetAtt ElasticIP.AllocationId
      InstanceId: !Ref EC2Instance

Mappings:
  RegionAMI:
    us-east-1:
      AMI: ami-0a0e5d9c7acc336f1
    us-east-2:
      AMI: ami-0b8b44ec9a8f90422
    us-west-1:
      AMI: ami-0657605d763ac72a8
    us-west-2:
      AMI: ami-03c983f9003cb9cd1

Outputs:
  PublicIP:
    Description: Elastic IP for DNS A records
    Value: !Ref ElasticIP

  SSHCommand:
    Description: SSH into the server
    Value: !Sub "ssh -i ${KeyPairName}.pem ubuntu@${ElasticIP}"

  DNSInstructions:
    Description: GoDaddy DNS records to create
    Value: !Sub |
      A record: @ → ${ElasticIP}
      A record: api → ${ElasticIP}
      A record: mcp → ${ElasticIP}
